<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Détail dossier</title>
  	<link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
	<link rel="stylesheet" th:href="@{/css/ft-theme.min.css}">
</head>
<body>

<div class="ft-shell">
<div th:replace="fragments/layout :: appHeader('Backoffice TTN — Détail')"></div>

<div class="container py-5" style="max-width: 1200px;">
  <div class="d-flex justify-content-between align-items-end mb-3">
    <div>
      <h3 class="mb-1">Dossier <span class="text-primary" th:text="${dossier.dossierRef}">REF</span></h3>
      <div class="text-muted">
        Statut : <b th:text="${dossier.statut}">SOUMIS</b>
        — Dernière MAJ : <span th:text="${#temporals.format(dossier.updatedAt,'yyyy-MM-dd HH:mm')}">date</span>
      </div>
    </div>
    <a class="btn btn-outline-secondary" th:href="@{/bo/dossiers}">Retour liste</a>
  </div>

  <div class="alert alert-danger" th:if="${error != null}" th:text="${error}"></div>
  <div class="alert alert-success" th:if="${success != null}" th:text="${success}"></div>

  <div class="row g-4">
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6>Données opérateur</h6>
          <div class="text-muted small mb-2">Entreprise</div>
          <ul class="mb-3">
            <li><b>Raison sociale :</b> <span th:text="${dossier.raisonSociale}"></span></li>
            <li><b>RC :</b> <span th:text="${dossier.registreCommerce}"></span></li>
            <li><b>MF :</b> <span th:text="${dossier.matriculeFiscal}"></span></li>
            <li><b>Adresse :</b> <span th:text="${dossier.adresse}"></span></li>
            <li><b>Email :</b> <span th:text="${dossier.emailGeneral}"></span></li>
          </ul>

          <div class="text-muted small mb-2">Responsables</div>
          <ul class="mb-0">
            <li><b>Resp légal :</b> <span th:text="${dossier.nomRespLegal}"></span> — <span th:text="${dossier.emailRespLegal}"></span></li>
            <li><b>Admin principal :</b> <span th:text="${dossier.nomAdminPrincipal}"></span> — <span th:text="${dossier.emailAdminPrincipal}"></span></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h6>Pièces jointes (dernières versions)</h6>

          <div class="alert alert-info small" th:if="${pieces == null || #lists.isEmpty(pieces)}">
            Aucune pièce trouvée.
          </div>

          <div class="d-flex flex-column gap-2" th:if="${pieces != null && !#lists.isEmpty(pieces)}">
            <div class="d-flex justify-content-between align-items-center border rounded p-2"
                 th:each="p : ${pieces}">
              <div>
                <div class="fw-semibold" th:text="${p.pieceType}">RC</div>
                <div class="text-muted small">
                  v<span th:text="${p.versionNo}">1</span> — <span th:text="${p.originalFilename}">file.pdf</span>
                </div>
              </div>

              <a class="btn btn-sm btn-outline-secondary"
                 th:href="@{/bo/pieces/{id}(id=${p.id})}">
                Voir
              </a>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body bg-info-subtle rounded">
          <h6 class="mb-2">Signature</h6>
          <div th:if="${dossier.signatureOk}">
            <div class="text-muted small">Certificat : <span th:text="${dossier.certAuthority}">CA</span> — Serial : <span th:text="${dossier.certSerial}">S</span></div>
            <div class="text-muted small">Horodatage : <span th:text="${dossier.horodatage}">date</span></div>
            <div class="text-muted small">Hash : <span th:text="${dossier.signatureHash}">hash</span></div>
          </div>
          <div th:if="${!dossier.signatureOk}" class="text-danger">
            Signature absente ou invalide.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mt-4">
    <div class="card-body">
      <h6>Décision TTN</h6>

      <div class="alert alert-warning small" th:if="${dossier.statut.name() != 'EN_INSTRUCTION'}">
        La décision est possible uniquement si le dossier est en <b>EN_INSTRUCTION</b>.
      </div>

      <form th:if="${dossier.statut.name() == 'EN_INSTRUCTION'}"
            th:action="@{/bo/dossiers/{ref}/decision(ref=${dossier.dossierRef})}"
            method="post" class="row g-3 align-items-center">

        <div class="col-lg-6">
          <div class="d-flex flex-wrap gap-4">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="decision" value="VALIDER" checked>
              <label class="form-check-label">Valider</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="decision" value="COMPLEMENT">
              <label class="form-check-label">Demander complément</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="decision" value="REJETER">
              <label class="form-check-label">Rejeter</label>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <input class="form-control" name="motif" placeholder="Motif (obligatoire si complément/rejet)">
        </div>

        <div class="col-lg-2 text-end">
          <button class="btn btn-primary w-100" type="submit">Notifier</button>
        </div>
      </form>

      <div class="mt-3 text-muted small" th:if="${dossier.motifDecision != null}">
        Dernier motif enregistré : <b th:text="${dossier.motifDecision}"></b>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mt-4">
    <div class="card-body">
      <h6>Journal d’audit</h6>
      <div class="alert alert-info small" th:if="${audit == null || #lists.isEmpty(audit)}">
        Aucun événement.
      </div>

      <div class="list-group" th:if="${audit != null && !#lists.isEmpty(audit)}">
        <div class="list-group-item" th:each="a : ${audit}">
          <div class="d-flex justify-content-between">
            <div class="fw-semibold" th:text="${a.action}">ACTION</div>
            <div class="text-muted small" th:text="${#temporals.format(a.createdAt,'yyyy-MM-dd HH:mm')}">date</div>
          </div>
          <div class="text-muted small">Acteur : <span th:text="${a.actor}">user</span></div>
          <div class="mt-1" th:text="${a.details}">details</div>
        </div>
      </div>

    </div>
  </div>

</div>

<div th:replace="fragments/layout :: appFooter"></div>
</div>

<script th:src="@{/js/ft-theme.js}"></script>

</body>
</html>
